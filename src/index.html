<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https:; connect-src 'self' https: wss: ws:; media-src 'self' https:;">
    <title>Heads Up</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: rgba(10, 10, 10, 0.95);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            line-height: 1.4;
            font-size: 12px;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 320px;
            max-width: 320px;
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.97) 0%, rgba(17, 17, 17, 0.97) 50%, rgba(15, 15, 15, 0.97) 100%);
        }


        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(20px);
            padding: 0.6rem;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            gap: 0.4rem;
            position: relative;
            z-index: 100;
            width: 100%;
            height: auto;
            flex-shrink: 0;
            order: 1;
        }

        .header-center {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0;
        }

        .logo {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            color: #000;
            box-shadow: 0 2px 10px rgba(0, 212, 255, 0.3);
        }

        .brand-text {
            display: flex;
            flex-direction: column;
        }

        .brand-name {
            font-size: 0.7rem;
            font-weight: 600;
            color: #ffffff;
            letter-spacing: -0.025em;
            line-height: 1.1;
        }

        .brand-tagline {
            font-size: 0.55rem;
            color: #888888;
            font-weight: 400;
            line-height: 1.1;
        }

        .header-controls {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.4rem;
        }

        .control-button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #ffffff;
            padding: 0.4rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', sans-serif;
            width: 28px;
            height: 28px;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        .window-control {
            margin-left: 0.2rem;
        }
        .window-control:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
        }
        #closeButton:hover {
            background: rgba(255, 59, 59, 0.2);
            border-color: rgba(255, 59, 59, 0.4);
            color: #ff6b6b;
        }

        .primary-button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            font-weight: 600;
            box-shadow: none;
        }

        .primary-button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .danger-button {
            background: linear-gradient(135deg, #ff3b3b 0%, #ff6b6b 100%);
            border: none;
            color: #ffffff;
            font-weight: 600;
        }

        .danger-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 59, 59, 0.3);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.3rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 0.65rem;
            font-weight: 500;
            width: 28px;
            height: 28px;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #666666;
        }

        .status-active .status-dot {
            background: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: calc(100vh - 52px);
            order: 2;
        }

        /* Live View */
        .live-view {
            background: rgba(0, 0, 0, 0.35);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
            overflow: hidden;
            flex-shrink: 0;
        }

        .live-view.collapsed {
            height: 0;
            border-bottom: none;
        }

        .live-view-header {
            padding: 0.4rem 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
        }

        .live-view-title {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: #ffffff;
        }

        .toggle-button {
            background: transparent;
            border: none;
            color: #888888;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .toggle-button:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.05);
        }

        .flowing-container {
            padding: 0.75rem;
            min-height: 60px;
            max-height: 120px;
            overflow-y: auto;
            position: relative;
        }

        .word-stream {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            align-items: baseline;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        .word {
            display: inline-block;
            padding: 0.1rem 0.2rem;
            border-radius: 3px;
            transition: all 0.3s ease;
            animation: wordSlide 0.4s ease;
            font-weight: 400;
            font-size: 0.65rem;
        }

        .word.interim {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .word.final {
            background: rgba(0, 212, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .word.high-confidence {
            background: rgba(0, 212, 255, 0.2);
            font-weight: 500;
        }

        @keyframes wordSlide {
            from {
                opacity: 0;
                transform: translateY(15px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .sentence-break {
            width: 100%;
            height: 0.8rem;
            display: block;
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 0.3rem 0.7rem;
            background: rgba(91, 141, 239, 0.15);
            border: 1px solid rgba(91, 141, 239, 0.3);
            border-radius: 6px;
            margin-left: 0.4rem;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #5b8def;
            animation: typingPulse 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingPulse {
            0%, 80%, 100% {
                opacity: 0.3;
                transform: scale(0.8);
            }
            40% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Content Mapping */
        .content-mapping-panel {
            background: rgba(10, 10, 10, 0.96);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
            overflow: hidden;
            height: auto;
            position: relative;
            z-index: 50;
        }

        .content-mapping-panel.collapsed {
            height: 0;
            border-bottom: none;
        }

        .mapping-header {
            padding: 0.4rem 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .mapping-title {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: #5b8def;
        }

        .mapping-content {
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: calc(100vh - 224px);
            overflow-y: auto;
        }

        .mapping-form {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            padding: 0.75rem;
            min-width: 0;
        }

        .form-group {
            margin-bottom: 0.6rem;
        }

        .form-group label {
            display: block;
            font-size: 0.7rem;
            font-weight: 500;
            color: #cccccc;
            margin-bottom: 0.25rem;
        }

        .form-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 5px;
            padding: 0.4rem;
            color: #ffffff;
            font-size: 0.7rem;
            font-family: 'Inter', sans-serif;
        }

        .form-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .form-textarea {
            min-height: 70px;
            resize: vertical;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        select.form-input {
            cursor: pointer;
        }

        .add-mapping-button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            padding: 0.4rem 0.8rem;
            border-radius: 5px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .add-mapping-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .mappings-list {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            padding: 0.75rem;
            height: 100%;
            overflow-y: auto;
        }

        .mapping-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            position: relative;
        }

        .mapping-item:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .mapping-keywords {
            font-size: 0.7rem;
            font-weight: 400;
            color: #888888;
            margin-bottom: 0.3rem;
            font-style: italic;
        }

        .mapping-content-text {
            font-size: 0.7rem;
            color: #aaaaaa;
            line-height: 1.4;
            max-height: 50px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            background: rgba(255, 255, 255, 0.02);
            padding: 0.4rem;
            border-radius: 3px;
            margin-top: 0.3rem;
        }

        .delete-mapping {
            background: transparent;
            border: none;
            color: #666666;
            cursor: pointer;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
        }

        .delete-mapping:hover {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }

        /* Coaching Section */
        .coaching-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0.75rem;
            background: rgba(10, 10, 10, 0.96);
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            flex-shrink: 0;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: #ffffff;
        }

        .coaching-grid {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            flex: 1;
            overflow-y: auto;
            padding-bottom: 0.75rem;
        }

        .coaching-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.07) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.75rem;
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
            animation: cardSlide 0.5s ease;
            max-height: 130px;
            overflow: hidden;
            position: relative;
        }

        .coaching-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .coaching-card:hover .dismiss-card {
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes cardSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .coaching-header {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.6rem;
        }

        .coaching-icon {
            width: 20px;
            height: 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .coaching-icon.objection {
            background: linear-gradient(135deg, #ff3b3b 0%, #ff6b6b 100%);
            color: #ffffff;
        }

        .coaching-icon.opportunity {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: #ffffff;
        }

        .coaching-icon.competitive {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #ffffff;
        }

        .coaching-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: #ffffff;
        }

        .coaching-text {
            color: #cccccc;
            line-height: 1.4;
            font-size: 0.65rem;
        }

        .coaching-timestamp {
            margin-top: 0.6rem;
            font-size: 0.6rem;
            color: #666666;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .dismiss-card {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 20px;
            height: 20px;
            background: rgba(34, 197, 94, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            transform: translateY(-5px);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #ffffff;
            z-index: 10;
        }

        .dismiss-card:hover {
            background: rgba(34, 197, 94, 1);
            transform: translateY(0) scale(1.1);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }

        .dismiss-card:active {
            transform: translateY(0) scale(0.95);
        }

        .coaching-card.dismissing {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
            max-height: 0;
            padding: 0;
            margin-bottom: 0;
            overflow: hidden;
        }

        /* Empty States */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            text-align: center;
            color: #666666;
        }

        .empty-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
            color: #888888;
        }

        .empty-subtitle {
            font-size: 0.7rem;
            line-height: 1.4;
        }

        /* Audio Visualization */
        .audio-visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .audio-bars {
            display: flex;
            gap: 2px;
            align-items: end;
            height: 16px;
        }

        .audio-bar {
            width: 2px;
            background: #22c55e;
            border-radius: 1px;
            transition: height 0.1s ease;
            opacity: 0.7;
        }

        /* Stats */
        .stats-row {
            display: flex;
            gap: 1rem;
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
        }

        .stat-number {
            font-size: 1rem;
            font-weight: 700;
            color: #ffffff;
        }

        .stat-label {
            font-size: 0.6rem;
            color: #888888;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Responsive - Fine-tuning for 280px frameless display */
        @media (max-width: 300px) {
            .app-container {
                width: 100%;
                max-width: 100%;
            }
            
            body {
                font-size: 11px;
            }
            
            
            .header {
                padding: 0.5rem;
            }
            
            .logo {
                width: 20px;
                height: 20px;
                font-size: 0.7rem;
            }
            
            .brand-name {
                font-size: 0.65rem;
            }
            
            .brand-tagline {
                font-size: 0.5rem;
            }
            
            .control-button {
                width: 24px;
                height: 24px;
                font-size: 0.65rem;
            }
            
            .status-indicator {
                width: 24px;
                height: 24px;
            }
            
            .flowing-container {
                padding: 0.6rem;
                min-height: 50px;
                max-height: 100px;
            }
            
            .coaching-section {
                padding: 0.6rem;
            }
            
            .mapping-content {
                padding: 0.6rem;
            }
            
            .coaching-card {
                padding: 0.6rem;
                max-height: 110px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 3px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Tutorial Overlay */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.82);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .tutorial-card {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.96) 0%, rgba(42, 42, 42, 0.96) 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 3rem;
            max-width: 600px;
            width: 90%;
            text-align: center;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .tutorial-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            color: #ffffff;
        }

        .tutorial-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 1rem;
        }

        .tutorial-description {
            font-size: 1rem;
            color: #cccccc;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .tutorial-features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .tutorial-feature {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .tutorial-feature-icon {
            font-size: 1.2rem;
            margin-top: 0.1rem;
        }

        .tutorial-feature-text {
            font-size: 0.9rem;
            color: #aaaaaa;
            line-height: 1.4;
        }

        .tutorial-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .tutorial-button {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .tutorial-button-primary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
        }

        .tutorial-button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .tutorial-button-secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }

        .tutorial-button-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tutorial-step-indicator {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .tutorial-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .tutorial-dot.active {
            background: #22c55e;
            transform: scale(1.2);
        }

        /* Settings Menu */
        .settings-menu {
            position: absolute;
            top: 0;
            right: 100%;
            margin-right: 0.5rem;
            background: rgba(0, 0, 0, 0.92);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 0.5rem;
            min-width: 180px;
            max-width: 250px;
            z-index: 100;
            opacity: 0;
            transform: translateX(10px);
            pointer-events: none;
            transition: all 0.2s ease;
        }

        .settings-menu.visible {
            opacity: 1;
            transform: translateX(0);
            pointer-events: all;
        }

        /* Responsive adjustments for narrow screens */
        @media (max-width: 350px) {
            .settings-menu {
                right: 0;
                margin-right: 0;
                min-width: 160px;
                max-width: 200px;
            }
        }

        .settings-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            color: #cccccc;
        }

        .settings-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .settings-item i {
            width: 16px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .tutorial-features {
                grid-template-columns: 1fr;
            }
            
            .tutorial-card {
                padding: 2rem;
            }
            
            .tutorial-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        
        <!-- Header -->
        <div class="header">

            <div class="header-center">
                <div class="audio-visualizer" id="audioVisualizer" style="display: none;">
                    <div class="audio-bars">
                        <div class="audio-bar" style="height: 3px;"></div>
                        <div class="audio-bar" style="height: 6px;"></div>
                        <div class="audio-bar" style="height: 9px;"></div>
                        <div class="audio-bar" style="height: 5px;"></div>
                        <div class="audio-bar" style="height: 8px;"></div>
                    </div>
                </div>

                <div id="statusIndicator" class="status-indicator">
                    <div class="status-dot"></div>
                </div>
            </div>

            <div class="header-controls">
                <button id="toggleLiveView" class="control-button" title="Toggle live transcription view">
                    <i data-feather="eye"></i>
                </button>

                <button id="startButton" class="control-button primary-button" title="Start live speech recognition and coaching analysis">
                    <i data-feather="mic"></i>
                </button>

                <div style="position: relative;">
                    <button id="settingsButton" class="control-button" title="Access settings, tutorial, export data, and manage saved sessions">
                        <i data-feather="settings"></i>
                    </button>
                    
                    <!-- Settings Menu -->
                    <div class="settings-menu" id="settingsMenu">
                    <div class="settings-item" onclick="app.toggleContentMapping(); app.hideSettings();">
                        <i data-feather="map"></i>
                        <span>Content Mapping</span>
                    </div>
                    <div class="settings-item" onclick="app.showTutorial()">
                        <i data-feather="book-open"></i>
                        <span>Show Tutorial</span>
                    </div>
                    <div class="settings-item" onclick="app.clearAllMappings()">
                        <i data-feather="trash-2"></i>
                        <span>Clear All Mappings</span>
                    </div>
                    <div class="settings-item" onclick="app.exportMappings()">
                        <i data-feather="download"></i>
                        <span>Export Mappings</span>
                    </div>
                    <div class="settings-item" onclick="app.viewSavedSessions()">
                        <i data-feather="clock"></i>
                        <span>View Saved Sessions</span>
                    </div>
                    <div class="settings-item" onclick="app.showLLMSettings()">
                        <i data-feather="cpu"></i>
                        <span>LLM Settings</span>
                    </div>
                    </div>
                </div>

                <button id="stopButton" class="control-button danger-button" style="display: none;" title="Stop recording and generate session summary">
                    <i data-feather="square"></i>
                </button>

                <button id="saveSessionButton" class="control-button" style="display: none;" title="Save current session transcript and clear for next session">
                    <i data-feather="save"></i>
                </button>

                <button id="summarizeButton" class="control-button" style="display: none;" title="Send transcript to LLM for analysis">
                    <i data-feather="zap"></i>
                </button>

                <!-- Window controls -->
                <button id="minimizeButton" class="control-button window-control" title="Minimize window">
                    <i data-feather="minus"></i>
                </button>
                <button id="closeButton" class="control-button window-control" title="Close window">
                    <i data-feather="x"></i>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Live View -->
            <div class="live-view" id="liveView">
                <div class="live-view-header">
                    <div class="live-view-title">
                        <i data-feather="activity"></i>
                        <span>Live Transcription Stream</span>
                    </div>
                </div>
                
                <div class="flowing-container">
                    <div id="wordStream" class="word-stream">
                        <div class="empty-state">
                            <div class="empty-icon">🎙️</div>
                            <div class="empty-title">Ready for Live Transcription</div>
                            <div class="empty-subtitle">Speak naturally and watch your words flow in real-time</div>
                        </div>
                    </div>
                </div>

                <div class="stats-row">
                    <div class="stat">
                        <div class="stat-number" id="wordCount">0</div>
                        <div class="stat-label">Words</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="sentenceCount">0</div>
                        <div class="stat-label">Sentences</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="confidenceAvg">0%</div>
                        <div class="stat-label">Confidence</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="sessionTime">00:00</div>
                        <div class="stat-label">Session</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="startTime">--:--</div>
                        <div class="stat-label">Started</div>
                    </div>
                </div>
            </div>

            <!-- Content Mapping Panel -->
            <div class="content-mapping-panel collapsed" id="contentMappingPanel">
                <div class="mapping-header">
                    <div class="mapping-title">
                        <i data-feather="settings"></i>
                        <span>Content Mapping Configuration</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 0.8rem; color: #666666;">Configure AI coaching responses</span>
                        <button class="toggle-button" id="closeMappingPanel" title="Close content mapping panel and return to coaching view">
                            <i data-feather="x"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mapping-content">
                    <div class="mapping-form">
                        <h4 style="color: #ffffff; margin-bottom: 1rem; font-size: 1rem;">Add New Content Mapping</h4>
                        
                        <div class="form-group">
                            <label for="mappingType">Type</label>
                            <select id="mappingType" class="form-input">
                                <option value="hint">💡 Hint</option>
                                <option value="compintel">🎯 Competitive Intelligence</option>
                                <option value="keyword">🔑 Keyword Response</option>
                                <option value="objection">🛡️ Objection Handler</option>
                                <option value="closing">🤝 Closing Technique</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="mappingKeywords">Keywords/Phrases (comma-separated)</label>
                            <input type="text" id="mappingKeywords" class="form-input" placeholder="e.g., IncidentIO, Incident IO, incident management">
                        </div>
                        
                        <div class="form-group">
                            <label for="mappingContent">Coaching Content (HTML supported)</label>
                            <textarea id="mappingContent" class="form-input form-textarea" placeholder="Enter the coaching advice with emojis and formatting..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="fuzzyMatching" checked style="margin-right: 0.5rem;">
                                Enable fuzzy matching
                            </label>
                        </div>
                        
                        <button class="add-mapping-button" id="addMappingButton">
                            <i data-feather="plus"></i> Add Mapping
                        </button>
                    </div>
                    
                    <div class="mappings-list">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="color: #ffffff; font-size: 1rem; margin: 0;">Active Mappings</h4>
                            <span id="mappingCount" style="font-size: 0.8rem; color: #666666;">0 mappings</span>
                        </div>
                        <div id="mappingsList">
                            <div class="empty-state" style="padding: 3rem 2rem; text-align: center; color: #666666;">
                                <div style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;">📦</div>
                                <div style="font-size: 0.9rem;">No content mappings configured yet</div>
                                <div style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.7;">Add keywords and coaching content to get started</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coaching Section -->
            <div class="coaching-section">
                <div class="section-header">
                    <div class="section-title">
                        <i data-feather="zap"></i>
                        <span>Heads Up</span>
                    </div>
                </div>

                <div class="coaching-grid" id="coachingGrid">
                    <div class="empty-state">
                        <div class="empty-icon">🧠</div>
                        <div class="empty-title">Heads Up</div>
                        <div class="empty-subtitle">
                            Start recording to receive real-time coaching insights based on your speech patterns and content mappings.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class HeadsUp {
            constructor() {
                this.isRecording = false;
                this.recognition = null;
                this.audioContext = null;
                this.mediaStream = null;
                
                // Metrics
                this.wordCount = 0;
                this.sentenceCount = 0;
                this.confidenceSum = 0;
                this.confidenceCount = 0;
                this.sessionStartTime = null;
                this.sessionEndTime = null;
                this.sessionTimer = null;
                this.recordingStartTimestamp = null;
                this.recordingEndTimestamp = null;
                
                // Session data
                this.currentSessionTranscript = '';
                this.savedSessions = [];
                this.sessionTriggeredTips = new Set(); // Track tips shown in current session
                
                // LLM Configuration
                this.llmConfig = {
                    provider: 'openai', // openai, ollama, claude
                    apiKey: '',
                    baseUrl: 'http://localhost:11434', // for ollama
                    model: 'gpt-3.5-turbo',
                    prompt: 'Please analyze this sales conversation transcript and provide:\n\n1. Key insights about the conversation\n2. Strengths in the sales approach\n3. Areas for improvement\n4. Action items for follow-up\n\nTranscript:\n{transcript}',
                    autoSummarize: 'ask' // 'never', 'ask', 'always'
                };
                
                // Word flow
                this.currentSentence = [];
                this.typingIndicator = null;
                
                // Content mapping system
                this.contentMappings = [];
                this.mappingPanelVisible = false;
                
                // Live view toggle
                this.liveViewVisible = true;
                
                // Speech recognition restart counter
                this.restartCount = 0;
                this.maxRestarts = 5;
                
                // Sentence assembly
                this.sentenceBuffer = [];
                this.sentenceTimeout = null;
                
                // Tutorial system
                this.tutorialSteps = [
                    {
                        icon: '🎙️',
                        title: 'Welcome to Heads Up',
                        description: 'Your AI-powered sales coaching assistant that provides real-time guidance during conversations.',
                        features: [
                            { icon: '🎯', text: 'Real-time speech transcription' },
                            { icon: '🤖', text: 'AI coaching suggestions' },
                            { icon: '🔍', text: 'Smart keyword detection' },
                            { icon: '💾', text: 'Persistent content mappings' }
                        ]
                    },
                    {
                        icon: '🎤',
                        title: 'Live Transcription',
                        description: 'Click "Start Recording" to begin live speech recognition. Your words will flow in real-time.',
                        features: [
                            { icon: '🌊', text: 'Flowing word display' },
                            { icon: '📊', text: 'Session metrics tracking' },
                            { icon: '🔇', text: 'Toggle live view visibility' },
                            { icon: '🎚️', text: 'Audio level visualization' }
                        ]
                    },
                    {
                        icon: '🎯',
                        title: 'Content Mapping',
                        description: 'Create custom coaching responses that trigger when specific keywords are detected.',
                        features: [
                            { icon: '💡', text: 'Hints and tips' },
                            { icon: '🏆', text: 'Competitive intelligence' },
                            { icon: '🛡️', text: 'Objection handling' },
                            { icon: '🤝', text: 'Closing techniques' }
                        ]
                    },
                    {
                        icon: '🚀',
                        title: 'Ready to Start!',
                        description: 'You\'re all set! Click "Start Recording" to begin your first coaching session.',
                        features: [
                            { icon: '🎙️', text: 'Grant microphone permission' },
                            { icon: '💬', text: 'Speak naturally' },
                            { icon: '🎓', text: 'Receive AI coaching' },
                            { icon: '⚙️', text: 'Configure content mappings' }
                        ]
                    }
                ];
                this.currentTutorialStep = 0;
                
                this.setupEventListeners();
                this.initializeUI();
                this.loadContentMappings();
                this.loadSavedSessions();
                this.loadLLMConfig();
                this.checkFirstTime();
                this.setupElectronIntegration();
                
                // Initialize Feather icons
                setTimeout(() => feather.replace(), 100);
            }

            setupEventListeners() {
                document.getElementById('startButton').addEventListener('click', () => this.start());
                document.getElementById('stopButton').addEventListener('click', () => this.stop());
                // Window controls
                document.getElementById('minimizeButton').addEventListener('click', () => this.minimizeWindow());
                document.getElementById('closeButton').addEventListener('click', () => this.closeWindow());
                document.getElementById('toggleLiveView').addEventListener('click', () => this.toggleLiveView());
                document.getElementById('closeMappingPanel').addEventListener('click', () => this.toggleContentMapping());
                document.getElementById('addMappingButton').addEventListener('click', () => this.addContentMapping());
                document.getElementById('settingsButton').addEventListener('click', (e) => this.toggleSettings(e));
                document.getElementById('saveSessionButton').addEventListener('click', () => this.saveCurrentSession());
                document.getElementById('summarizeButton').addEventListener('click', () => this.summarizeWithLLM());
                
                // Close settings when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#settingsButton') && !e.target.closest('.settings-menu')) {
                        this.hideSettings();
                    }
                });
            }

            initializeUI() {
                // Initialize session timer display
                this.updateSessionTimer();
                
                // Set initial state based on liveViewVisible
                const liveView = document.getElementById('liveView');
                const coachingSection = document.querySelector('.coaching-section');
                
                if (this.liveViewVisible) {
                    // Live view visible, coaching hidden
                    liveView.classList.remove('collapsed');
                    if (coachingSection) coachingSection.style.display = 'none';
                } else {
                    // Live view hidden, coaching visible
                    liveView.classList.add('collapsed');
                    if (coachingSection) coachingSection.style.display = 'flex';
                }
            }


            // Window control methods
            minimizeWindow() {
                if (window.electronAPI?.minimizeWindow) {
                    window.electronAPI.minimizeWindow();
                }
            }

            closeWindow() {
                if (window.electronAPI?.closeWindow) {
                    window.electronAPI.closeWindow();
                }
            }

            async start() {
                try {
                    this.showDebug('Starting microphone access...');
                    
                    // First check if permission is already granted
                    const permission = await navigator.permissions.query({ name: 'microphone' });
                    this.showDebug(`Microphone permission status: ${permission.state}`);
                    
                    // Check network connectivity for speech recognition
                    this.showDebug(`Online status: ${navigator.onLine}`);
                    
                    this.mediaStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true  // Simplified for better compatibility
                    });
                    
                    this.showDebug('Microphone access granted, setting up recognition...');
                    this.setupAudioVisualization();
                    this.setupSpeechRecognition();
                    this.showDebug('Starting speech recognition...');
                    this.restartCount = 0; // Reset counter when starting fresh
                    this.recognition.start();
                    
                    this.sessionStartTime = Date.now();
                    this.recordingStartTimestamp = new Date();
                    this.startSessionTimer();
                    this.logSessionEvent('Recording started');
                    
                } catch (error) {
                    this.showDebug(`Microphone error: ${error.name} - ${error.message}`);
                    if (error.name === 'NotAllowedError') {
                        this.showError('Microphone permission denied. Please check System Settings > Privacy & Security > Microphone');
                    } else if (error.name === 'NotFoundError') {
                        this.showError('No microphone found. Please connect a microphone.');
                    } else {
                        this.showError('Microphone access denied: ' + error.message);
                    }
                }
            }
            
            // Add manual restart for testing
            restartSpeechRecognition() {
                if (this.recognition && this.isRecording) {
                    this.showDebug('Manually restarting speech recognition...');
                    try {
                        this.recognition.start();
                    } catch (error) {
                        this.showDebug(`Manual restart failed: ${error.message}`);
                    }
                }
            }
            
            // Demo mode with simulated speech for testing
            startDemoMode() {
                this.showDebug('Starting demo mode with simulated speech...');
                this.demoActive = true;
                
                const demoWords = [
                    'Hello this is a test of the speech recognition system',
                    'The price is quite high for this product',
                    'I need to think about this decision carefully',
                    'How does this compare to your competitors',
                    'What are the main benefits of using your service',
                    'The budget is a concern for our team'
                ];
                
                let wordIndex = 0;
                this.demoInterval = setInterval(() => {
                    if (!this.isRecording || !this.demoActive) {
                        clearInterval(this.demoInterval);
                        return;
                    }
                    
                    const sentence = demoWords[wordIndex % demoWords.length];
                    this.showDebug(`Demo speech: "${sentence}"`);
                    this.addFinalWords(sentence, 0.9);
                    this.checkCoachingTriggers(sentence);
                    wordIndex++;
                    
                }, 3000); // Every 3 seconds
            }

            setupAudioVisualization() {
                this.audioContext = new AudioContext();
                const source = this.audioContext.createMediaStreamSource(this.mediaStream);
                const analyser = this.audioContext.createAnalyser();
                
                analyser.fftSize = 256;
                source.connect(analyser);
                
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                const updateVisualizer = () => {
                    if (!this.isRecording) return;
                    
                    analyser.getByteFrequencyData(dataArray);
                    
                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        sum += dataArray[i];
                    }
                    const average = sum / bufferLength;
                    
                    this.updateAudioBars(average);
                    requestAnimationFrame(updateVisualizer);
                };
                
                updateVisualizer();
            }

            updateAudioBars(level) {
                const audioBars = document.querySelectorAll('.audio-bar');
                const normalizedLevel = Math.min(level / 60, 1);
                
                audioBars.forEach((bar, index) => {
                    const barHeight = Math.max(2, normalizedLevel * 16 * (index + 1) / audioBars.length);
                    bar.style.height = `${barHeight}px`;
                    bar.style.opacity = normalizedLevel > (index / audioBars.length) ? '1' : '0.3';
                });
            }

            setupSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    console.error('Speech recognition not supported');
                    this.showDebug('Speech recognition not supported in this browser');
                    this.showError('Speech recognition not supported. Please use Chrome or Safari.');
                    return;
                }

                this.showDebug('Speech recognition API found, setting up...');
                this.showDebug(`User agent: ${navigator.userAgent}`);
                console.log('Setting up speech recognition...');
                
                this.recognition = new SpeechRecognition();
                
                // Try to force local recognition instead of cloud
                try {
                    // Some browsers support local recognition
                    this.recognition.serviceURI = '';
                    this.recognition.grammars = new (window.SpeechGrammarList || window.webkitSpeechGrammarList)();
                } catch (e) {
                    this.showDebug('Local speech grammar not available');
                }
                
                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.lang = 'en-US';
                this.recognition.maxAlternatives = 1;

                this.recognition.onresult = (event) => {
                    console.log('Speech recognition result received:', event);
                    this.showDebug('Speech result received!');
                    this.processResults(event);
                };

                this.recognition.onstart = () => {
                    this.isRecording = true;
                    this.updateUI();
                    this.clearWordStream();
                    this.showDebug('Speech recognition started successfully!');
                };

                this.recognition.onend = () => {
                    this.showDebug('Speech recognition ended');
                    // Restart if still recording and under restart limit
                    if (this.isRecording && this.recognition && this.restartCount < this.maxRestarts) {
                        this.restartCount++;
                        setTimeout(() => {
                            if (this.isRecording && this.recognition) {
                                try {
                                    this.recognition.start();
                                    this.showDebug(`Restarted speech recognition (${this.restartCount}/${this.maxRestarts})`);
                                } catch (error) {
                                    this.showDebug(`Restart failed: ${error.message}`);
                                }
                            }
                        }, 1000); // Longer delay
                    } else if (this.restartCount >= this.maxRestarts) {
                        this.showDebug('Max restarts reached - stopping recognition');
                        this.stop();
                    }
                };

                this.recognition.onerror = (event) => {
                    this.showDebug(`Speech recognition error: ${event.error}`);
                    if (event.error === 'not-allowed') {
                        this.showError('Microphone permission denied');
                        this.stop();
                    } else if (event.error === 'no-speech') {
                        this.showDebug('No speech detected - will restart...');
                    } else if (event.error === 'network') {
                        this.showDebug('Network error - switching to demo mode');
                        this.startDemoMode(); // Start demo mode instead of stopping
                    } else if (event.error === 'service-not-allowed') {
                        this.showDebug('Speech service blocked - stopping');
                        this.stop();
                    } else if (event.error === 'bad-grammar') {
                        this.showDebug('Grammar error - continuing...');
                    } else {
                        this.showDebug(`Unknown error: ${event.error} - stopping`);
                        this.stop();
                    }
                };
            }

            processResults(event) {
                console.log('Processing speech results...');
                this.showDebug('Processing speech results...');
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    const transcript = result[0].transcript;
                    const confidence = result[0].confidence || 0.9;
                    const isFinal = result.isFinal;
                    
                    console.log('Transcript:', transcript, 'Final:', isFinal, 'Confidence:', confidence);
                    this.showDebug(`Got: "${transcript}" (${isFinal ? 'final' : 'interim'})`);
                    
                    if (transcript.trim().length === 0) continue;
                    
                    if (isFinal) {
                        this.addFinalWords(transcript, confidence);
                        this.removeTypingIndicator();
                        this.updateConfidenceMetrics(confidence);
                    } else {
                        this.showInterimWords(transcript);
                    }
                    
                    // Always analyze for coaching on both interim and final results
                    this.analyzeForCoaching(transcript, isFinal);
                }
            }

            showInterimWords(transcript) {
                this.removeInterimWords();
                
                const words = transcript.trim().split(/\s+/);
                const wordStream = document.getElementById('wordStream');
                
                words.forEach((word, index) => {
                    if (word.length > 0) {
                        const wordElement = this.createWordElement(word, 'interim');
                        wordStream.appendChild(wordElement);
                    }
                });
                
                this.addTypingIndicator();
                this.scrollToBottom();
            }

            addFinalWords(transcript, confidence) {
                this.removeInterimWords();
                
                const words = transcript.trim().split(/\s+/);
                const wordStream = document.getElementById('wordStream');
                
                words.forEach((word) => {
                    if (word.length > 0) {
                        const wordElement = this.createWordElement(word, 'final', confidence);
                        wordStream.appendChild(wordElement);
                        this.wordCount++;
                        this.currentSentence.push(word);
                        
                        // Add to session transcript
                        this.currentSessionTranscript += (this.currentSessionTranscript ? ' ' : '') + word;
                    }
                });
                
                // Add words to sentence buffer for better sentence assembly
                words.forEach((word) => {
                    if (word.length > 0) {
                        this.sentenceBuffer.push(word);
                    }
                });
                
                // Clear existing sentence timeout
                if (this.sentenceTimeout) {
                    clearTimeout(this.sentenceTimeout);
                }
                
                // Set timeout to complete sentence if no new words arrive
                this.sentenceTimeout = setTimeout(() => {
                    if (this.sentenceBuffer.length > 0) {
                        this.processSentenceBuffer();
                    }
                }, 2000);
                
                if (this.isSentenceEnd(transcript)) {
                    this.processSentenceBuffer();
                }
                
                this.updateStats();
                this.scrollToBottom();
            }

            createWordElement(word, type, confidence = 0.9) {
                const wordElement = document.createElement('span');
                wordElement.className = `word ${type}`;
                if (type === 'final' && confidence > 0.9) {
                    wordElement.classList.add('high-confidence');
                }
                wordElement.textContent = word;
                return wordElement;
            }

            removeInterimWords() {
                const wordStream = document.getElementById('wordStream');
                const interimWords = wordStream.querySelectorAll('.word.interim');
                interimWords.forEach(word => word.remove());
                this.removeTypingIndicator();
            }

            addTypingIndicator() {
                if (this.typingIndicator) return;
                
                const wordStream = document.getElementById('wordStream');
                this.typingIndicator = document.createElement('div');
                this.typingIndicator.className = 'typing-indicator';
                this.typingIndicator.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                `;
                wordStream.appendChild(this.typingIndicator);
            }

            removeTypingIndicator() {
                if (this.typingIndicator) {
                    this.typingIndicator.remove();
                    this.typingIndicator = null;
                }
            }

            isSentenceEnd(text) {
                return /[.!?]$/.test(text.trim()) || this.currentSentence.length > 15;
            }

            completeSentence() {
                if (this.currentSentence.length === 0) return;
                
                const wordStream = document.getElementById('wordStream');
                const sentenceBreak = document.createElement('div');
                sentenceBreak.className = 'sentence-break';
                wordStream.appendChild(sentenceBreak);
                
                this.sentenceCount++;
                this.currentSentence = [];
            }

            updateConfidenceMetrics(confidence) {
                this.confidenceSum += confidence;
                this.confidenceCount++;
            }

            updateStats() {
                document.getElementById('wordCount').textContent = this.wordCount;
                document.getElementById('sentenceCount').textContent = this.sentenceCount;
                
                if (this.confidenceCount > 0) {
                    const avgConfidence = Math.round((this.confidenceSum / this.confidenceCount) * 100);
                    document.getElementById('confidenceAvg').textContent = `${avgConfidence}%`;
                }
            }

            startSessionTimer() {
                this.sessionTimer = setInterval(() => {
                    this.updateSessionTimer();
                }, 1000);
            }

            updateSessionTimer() {
                if (!this.sessionStartTime) {
                    document.getElementById('sessionTime').textContent = '00:00';
                    const startTimeElement = document.getElementById('startTime');
                    if (startTimeElement) startTimeElement.textContent = '--:--';
                    return;
                }
                
                const elapsed = Math.floor((Date.now() - this.sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('sessionTime').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Update start time display
                if (this.recordingStartTimestamp) {
                    const startTimeElement = document.getElementById('startTime');
                    if (startTimeElement) {
                        startTimeElement.textContent = 
                            this.recordingStartTimestamp.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                    }
                }
            }

            clearWordStream() {
                const wordStream = document.getElementById('wordStream');
                const emptyState = wordStream.querySelector('.empty-state');
                if (emptyState) {
                    wordStream.innerHTML = '';
                }
                
                this.wordCount = 0;
                this.sentenceCount = 0;
                this.confidenceSum = 0;
                this.confidenceCount = 0;
                this.currentSentence = [];
                this.currentSessionTranscript = '';
                this.sessionTriggeredTips.clear(); // Reset session tip tracking
                this.updateStats();
            }

            resetSession() {
                // Reset all session data
                this.sessionStartTime = null;
                this.sessionEndTime = null;
                this.recordingStartTimestamp = null;
                this.recordingEndTimestamp = null;
                this.sessionLogs = [];
                this.currentSessionTranscript = '';
                this.sessionTriggeredTips.clear(); // Reset session tip tracking
                
                // Reset UI
                this.updateSessionTimer();
            }

            scrollToBottom() {
                const container = document.querySelector('.flowing-container');
                container.scrollTop = container.scrollHeight;
            }

            analyzeForCoaching(text, isFinal = false) {
                const lowerText = text.toLowerCase();
                
                // Initialize recent triggers tracking if needed
                if (!this.recentTriggers) {
                    this.recentTriggers = new Map();
                }
                
                // Clean up old triggers (older than 15 seconds for immediate response)
                const now = Date.now();
                for (const [key, timestamp] of this.recentTriggers.entries()) {
                    if (now - timestamp > 15000) {
                        this.recentTriggers.delete(key);
                    }
                }
                
                // Check content mappings - trigger immediately on any match
                let foundMapping = false;
                for (const mapping of this.contentMappings) {
                    const matchedKeyword = this.findMatchedKeyword(lowerText, mapping.keywords, mapping.fuzzy);
                    if (matchedKeyword) {
                        const triggerKey = `${mapping.id}-${matchedKeyword}`;
                        const sessionTipKey = `${mapping.id}`;
                        
                        // Check if this tip was already shown in current session
                        if (this.sessionTriggeredTips.has(sessionTipKey)) {
                            continue; // Skip if already shown in this session
                        }
                        
                        // Very short cooldown for immediate response (2 seconds)
                        if (!this.recentTriggers.has(triggerKey) || (now - this.recentTriggers.get(triggerKey)) > 2000) {
                            const typeInfo = this.getMappingTypeInfo(mapping.type);
                            const titleWithKeyword = `${typeInfo.title} (${matchedKeyword})`;
                            this.addCoaching(titleWithKeyword, mapping.content, typeInfo.style, typeInfo.icon, mapping.id);
                            this.recentTriggers.set(triggerKey, now);
                            this.sessionTriggeredTips.add(sessionTipKey); // Mark as shown in session
                            foundMapping = true;
                        }
                    }
                }
                
                // Default coaching rules - also trigger immediately but with longer cooldown
                if (!foundMapping) {
                    if (lowerText.includes('price') || lowerText.includes('cost') || lowerText.includes('budget')) {
                        const triggerKey = 'default-price';
                        if (!this.sessionTriggeredTips.has('default-price') && 
                            (!this.recentTriggers.has(triggerKey) || (now - this.recentTriggers.get(triggerKey)) > 8000)) {
                            this.addCoaching('Price Objection', 'Focus on value and ROI. Ask about the cost of not solving the problem.', 'objection', 'dollar-sign');
                            this.recentTriggers.set(triggerKey, now);
                            this.sessionTriggeredTips.add('default-price');
                        }
                    }
                    
                    if (lowerText.includes('think about') || lowerText.includes('consider')) {
                        const triggerKey = 'default-closing';
                        if (!this.sessionTriggeredTips.has('default-closing') && 
                            (!this.recentTriggers.has(triggerKey) || (now - this.recentTriggers.get(triggerKey)) > 8000)) {
                            this.addCoaching('Closing Opportunity', 'Perfect timing to address concerns and move forward.', 'opportunity', 'handshake');
                            this.recentTriggers.set(triggerKey, now);
                            this.sessionTriggeredTips.add('default-closing');
                        }
                    }
                    
                    if (lowerText.includes('competitor') || lowerText.includes('compare')) {
                        const triggerKey = 'default-competitive';
                        if (!this.sessionTriggeredTips.has('default-competitive') && 
                            (!this.recentTriggers.has(triggerKey) || (now - this.recentTriggers.get(triggerKey)) > 8000)) {
                            this.addCoaching('Competitive Situation', 'Highlight unique differentiators and proven results.', 'competitive', 'award');
                            this.recentTriggers.set(triggerKey, now);
                            this.sessionTriggeredTips.add('default-competitive');
                        }
                    }
                }
            }
            
            getMappingTypeInfo(type) {
                const typeInfo = {
                    hint: { title: '💡 Hint', style: 'opportunity', icon: 'lightbulb' },
                    compintel: { title: '🎯 Competitive Intel', style: 'competitive', icon: 'target' },
                    keyword: { title: '🔑 Keyword Response', style: 'opportunity', icon: 'key' },
                    objection: { title: '🛡️ Objection Handler', style: 'objection', icon: 'shield' },
                    closing: { title: '🤝 Closing Technique', style: 'opportunity', icon: 'handshake' }
                };
                return typeInfo[type] || { title: '📝 Coaching', style: 'opportunity', icon: 'clipboard' };
            }

            addCoaching(title, text, type, iconClass, mappingId = null) {
                const coachingGrid = document.getElementById('coachingGrid');
                
                // Clear empty state
                const emptyState = coachingGrid.querySelector('.empty-state');
                if (emptyState) {
                    coachingGrid.innerHTML = '';
                }
                
                // Check for duplicate cards in the last 10 seconds
                const now = Date.now();
                const cardId = `${title}-${mappingId || text.substring(0, 20)}`;
                
                // Initialize recent cards tracking if needed
                if (!this.recentCards) {
                    this.recentCards = new Map();
                }
                
                // Check if this card was recently added
                if (this.recentCards.has(cardId)) {
                    const lastAdded = this.recentCards.get(cardId);
                    if (now - lastAdded < 10000) { // 10 second duplicate prevention
                        return;
                    }
                }
                
                this.recentCards.set(cardId, now);
                
                // Clean up old entries
                for (const [id, timestamp] of this.recentCards.entries()) {
                    if (now - timestamp > 30000) { // Remove entries older than 30 seconds
                        this.recentCards.delete(id);
                    }
                }

                const card = document.createElement('div');
                card.className = 'coaching-card';
                card.setAttribute('data-card-id', cardId);
                card.innerHTML = `
                    <button class="dismiss-card" onclick="app.dismissCard(this)" title="Got it, thanks!">
                        <i data-feather="thumbs-up"></i>
                    </button>
                    <div class="coaching-header">
                        <div class="coaching-icon ${type}">
                            <i data-feather="${iconClass}"></i>
                        </div>
                        <div class="coaching-title">${title}</div>
                    </div>
                    <div class="coaching-text">${text}</div>
                    <div class="coaching-timestamp">
                        <i data-feather="clock"></i>
                        <span>${new Date().toLocaleTimeString()}</span>
                    </div>
                `;

                coachingGrid.appendChild(card);
                
                // Initialize Feather icons for this card
                feather.replace();

                // Keep only last 6 coaching cards
                while (coachingGrid.children.length > 6) {
                    coachingGrid.removeChild(coachingGrid.firstChild);
                }
            }

            showError(message) {
                // Could implement a toast notification here
                alert(message);
            }
            
            showDebug(message) {
                console.log(message);
                // Also show in the live view for visual debugging
                const liveView = document.getElementById('liveView');
                if (liveView && !liveView.classList.contains('collapsed')) {
                    const wordStream = document.getElementById('wordStream');
                    const debugElement = document.createElement('div');
                    debugElement.style.cssText = 'color: #00ff00; font-size: 10px; margin: 2px; padding: 2px; background: rgba(0,0,0,0.5); border-radius: 3px;';
                    debugElement.textContent = `DEBUG: ${message}`;
                    wordStream.appendChild(debugElement);
                }
            }

            stop() {
                if (!this.isRecording) return; // Prevent multiple stops
                
                this.isRecording = false;
                this.recordingEndTimestamp = new Date();
                this.sessionEndTime = Date.now();
                
                this.removeTypingIndicator();
                
                // Stop speech recognition immediately
                if (this.recognition) {
                    this.recognition.onend = null; // Prevent auto-restart
                    this.recognition.stop();
                    this.recognition = null;
                }
                
                // Stop demo mode if active
                if (this.demoActive) {
                    this.demoActive = false;
                    if (this.demoInterval) {
                        clearInterval(this.demoInterval);
                        this.demoInterval = null;
                    }
                    this.showDebug('Demo mode stopped');
                }
                
                // Close audio context
                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }
                
                // Stop all media tracks
                if (this.mediaStream) {
                    this.mediaStream.getTracks().forEach(track => {
                        track.stop();
                        console.log('Stopped track:', track.kind);
                    });
                    this.mediaStream = null;
                }
                
                // Stop session timer
                if (this.sessionTimer) {
                    clearInterval(this.sessionTimer);
                    this.sessionTimer = null;
                }
                
                // Process any remaining sentence buffer
                if (this.sentenceBuffer.length > 0) {
                    this.processSentenceBuffer();
                }
                
                // Clear any pending sentence timeout
                if (this.sentenceTimeout) {
                    clearTimeout(this.sentenceTimeout);
                    this.sentenceTimeout = null;
                }
                
                this.logSessionEvent('Recording ended');
                this.addSessionSummaryCard();
                this.clearCoachingTips(); // Clear all coaching tips
                this.showSaveSessionOption();
                this.showSummarizeOption();
                this.updateUI();
                
                console.log('Recording stopped completely');
            }

            processSentenceBuffer() {
                if (this.sentenceBuffer.length === 0) return;
                
                const sentence = this.sentenceBuffer.join(' ');
                
                // Analyze complete sentence
                if (sentence.length > 5) {
                    this.analyzeForCoaching(sentence);
                }
                
                // Complete the sentence visually
                this.completeSentence();
                
                // Clear buffer
                this.sentenceBuffer = [];
                
                if (this.sentenceTimeout) {
                    clearTimeout(this.sentenceTimeout);
                    this.sentenceTimeout = null;
                }
            }

            updateUI() {
                const statusIndicator = document.getElementById('statusIndicator');
                const startButton = document.getElementById('startButton');
                const stopButton = document.getElementById('stopButton');
                const saveSessionButton = document.getElementById('saveSessionButton');
                const summarizeButton = document.getElementById('summarizeButton');
                const audioVisualizer = document.getElementById('audioVisualizer');

                if (this.isRecording) {
                    statusIndicator.className = 'status-indicator status-active';
                    statusIndicator.innerHTML = '<div class="status-dot"></div>';
                    startButton.style.display = 'none';
                    stopButton.style.display = 'flex';
                    saveSessionButton.style.display = 'none';
                    summarizeButton.style.display = 'none';
                    audioVisualizer.style.display = 'flex';
                } else {
                    statusIndicator.className = 'status-indicator';
                    statusIndicator.innerHTML = '<div class="status-dot"></div>';
                    startButton.style.display = 'flex';
                    stopButton.style.display = 'none';
                    audioVisualizer.style.display = 'none';
                }
            }

            // Content Mapping Methods
            toggleContentMapping() {
                const panel = document.getElementById('contentMappingPanel');
                const coachingSection = document.querySelector('.coaching-section');
                
                this.mappingPanelVisible = !this.mappingPanelVisible;
                
                if (this.mappingPanelVisible) {
                    panel.classList.remove('collapsed');
                    // Hide coaching section when mapping panel is open
                    coachingSection.style.display = 'none';
                } else {
                    panel.classList.add('collapsed');
                    // Show coaching section when mapping panel is closed
                    coachingSection.style.display = 'flex';
                }
            }

            toggleLiveView() {
                const liveView = document.getElementById('liveView');
                const button = document.getElementById('toggleLiveView');
                const icon = button.querySelector('i');
                const coachingSection = document.querySelector('.coaching-section');
                
                this.liveViewVisible = !this.liveViewVisible;
                
                if (this.liveViewVisible) {
                    liveView.classList.remove('collapsed');
                    icon.setAttribute('data-feather', 'eye-off');
                    button.title = 'Hide live transcription view';
                    // Hide coaching section when live view is shown
                    coachingSection.style.display = 'none';
                } else {
                    liveView.classList.add('collapsed');
                    icon.setAttribute('data-feather', 'eye');
                    button.title = 'Show live transcription view';
                    // Show coaching section when live view is hidden
                    coachingSection.style.display = 'flex';
                }
                feather.replace();
            }

            addContentMapping() {
                const typeSelect = document.getElementById('mappingType');
                const keywordsInput = document.getElementById('mappingKeywords');
                const contentInput = document.getElementById('mappingContent');
                const fuzzyCheckbox = document.getElementById('fuzzyMatching');
                
                const type = typeSelect.value;
                const keywords = keywordsInput.value.trim();
                const content = contentInput.value.trim();
                
                if (!keywords || !content) {
                    alert('Please enter both keywords and content.');
                    return;
                }
                
                const mapping = {
                    id: Date.now(),
                    type: type,
                    keywords: keywords.split(',').map(k => k.trim().toLowerCase()),
                    content: content,
                    fuzzy: fuzzyCheckbox.checked
                };
                
                this.contentMappings.push(mapping);
                this.saveContentMappings();
                this.renderContentMappings();
                
                // Clear form
                keywordsInput.value = '';
                contentInput.value = '';
                
                console.log('Mapping added:', mapping);
                console.log('Total mappings:', this.contentMappings.length);
            }

            deleteContentMapping(id) {
                this.contentMappings = this.contentMappings.filter(mapping => mapping.id !== id);
                this.saveContentMappings();
                this.renderContentMappings();
            }

            renderContentMappings() {
                const mappingsList = document.getElementById('mappingsList');
                
                const countElement = document.getElementById('mappingCount');
                if (countElement) {
                    countElement.textContent = `${this.contentMappings.length} mapping${this.contentMappings.length !== 1 ? 's' : ''}`;
                }
                
                if (this.contentMappings.length === 0) {
                    mappingsList.innerHTML = `
                        <div class="empty-state" style="padding: 3rem 2rem; text-align: center; color: #666666;">
                            <div style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;">📦</div>
                            <div style="font-size: 0.9rem;">No content mappings configured yet</div>
                            <div style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.7;">Add keywords and coaching content to get started</div>
                        </div>
                    `;
                    return;
                }
                
                mappingsList.innerHTML = this.contentMappings.map(mapping => {
                    const typeIcons = {
                        hint: '💡',
                        compintel: '🎯',
                        keyword: '🔑',
                        objection: '🛡️',
                        closing: '🤝'
                    };
                    const typeNames = {
                        hint: 'Hint',
                        compintel: 'CompIntel',
                        keyword: 'Keyword',
                        objection: 'Objection',
                        closing: 'Closing'
                    };
                    return `
                        <div class="mapping-item" data-id="${mapping.id}">
                            <button class="delete-mapping" data-mapping-id="${mapping.id}">
                                <i data-feather="trash-2"></i>
                            </button>
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.2rem;">${typeIcons[mapping.type] || '📝'}</span>
                                <span style="font-size: 0.9rem; color: #ffffff; font-weight: 600;">${typeNames[mapping.type] || 'General'}</span>
                            </div>
                            <div class="mapping-keywords">
                                Keywords: ${mapping.keywords.join(', ')} ${mapping.fuzzy ? '• Fuzzy matching enabled' : ''}
                            </div>
                            <div class="mapping-content-text">${mapping.content}</div>
                        </div>
                    `;
                }).join('');
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-mapping').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const mappingId = parseInt(e.currentTarget.getAttribute('data-mapping-id'));
                        this.deleteContentMapping(mappingId);
                    });
                });
            }

            findMatchedKeyword(text, keywords, fuzzy) {
                for (const keyword of keywords) {
                    if (fuzzy) {
                        if (this.fuzzyMatch(text, keyword)) {
                            return keyword;
                        }
                    } else {
                        if (text.includes(keyword)) {
                            return keyword;
                        }
                    }
                }
                return null;
            }
            
            matchesKeywords(text, keywords, fuzzy) {
                return this.findMatchedKeyword(text, keywords, fuzzy) !== null;
            }

            fuzzyMatch(text, keyword) {
                // Exact match
                if (text.includes(keyword)) {
                    return true;
                }
                
                // Remove spaces and special characters for fuzzy matching
                const cleanText = text.replace(/[\s\-_\.]/g, '').toLowerCase();
                const cleanKeyword = keyword.replace(/[\s\-_\.]/g, '').toLowerCase();
                
                if (cleanText.includes(cleanKeyword)) {
                    return true;
                }
                
                // Split compound words (e.g., "incidentio" matches "incident io")
                const words = keyword.split(/[\s\-_\.]/);
                if (words.length > 1) {
                    const joinedWords = words.join('').toLowerCase();
                    if (cleanText.includes(joinedWords)) {
                        return true;
                    }
                }
                
                // Levenshtein distance for very close matches
                if (keyword.length > 4) {
                    const distance = this.levenshteinDistance(cleanKeyword, cleanText);
                    const threshold = Math.floor(keyword.length * 0.2); // 20% difference allowed
                    if (distance <= threshold && cleanText.includes(cleanKeyword.substring(0, 3))) {
                        return true;
                    }
                }
                
                return false;
            }

            levenshteinDistance(str1, str2) {
                // Find the best substring match
                let minDistance = Infinity;
                
                // Check all substrings of str2 that are similar length to str1
                const len1 = str1.length;
                for (let i = 0; i <= str2.length - len1; i++) {
                    const substring = str2.substr(i, len1 + 2); // Allow some flexibility
                    const distance = this.calculateEditDistance(str1, substring);
                    minDistance = Math.min(minDistance, distance);
                }
                
                return minDistance;
            }
            
            calculateEditDistance(str1, str2) {
                const matrix = [];
                
                for (let i = 0; i <= str2.length; i++) {
                    matrix[i] = [i];
                }
                
                for (let j = 0; j <= str1.length; j++) {
                    matrix[0][j] = j;
                }
                
                for (let i = 1; i <= str2.length; i++) {
                    for (let j = 1; j <= str1.length; j++) {
                        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                            matrix[i][j] = matrix[i - 1][j - 1];
                        } else {
                            matrix[i][j] = Math.min(
                                matrix[i - 1][j - 1] + 1,
                                matrix[i][j - 1] + 1,
                                matrix[i - 1][j] + 1
                            );
                        }
                    }
                }
                
                return matrix[str2.length][str1.length];
            }

            saveContentMappings() {
                localStorage.setItem('salescoach_content_mappings', JSON.stringify(this.contentMappings));
            }

            loadContentMappings() {
                const stored = localStorage.getItem('salescoach_content_mappings');
                if (stored) {
                    this.contentMappings = JSON.parse(stored);
                    this.renderContentMappings();
                }
            }

            // Tutorial System
            checkFirstTime() {
                const hasSeenTutorial = localStorage.getItem('headsup_tutorial_seen');
                if (!hasSeenTutorial) {
                    setTimeout(() => this.showTutorial(), 1000);
                }
            }

            showTutorial() {
                this.currentTutorialStep = 0;
                this.renderTutorialStep();
                document.getElementById('tutorialOverlay').style.display = 'flex';
            }

            renderTutorialStep() {
                const step = this.tutorialSteps[this.currentTutorialStep];
                
                // Update step indicator
                const indicator = document.getElementById('tutorialStepIndicator');
                indicator.innerHTML = this.tutorialSteps.map((_, index) => 
                    `<div class="tutorial-dot ${index === this.currentTutorialStep ? 'active' : ''}"></div>`
                ).join('');
                
                // Update content
                document.getElementById('tutorialIcon').textContent = step.icon;
                document.getElementById('tutorialTitle').textContent = step.title;
                document.getElementById('tutorialDescription').textContent = step.description;
                
                // Update features
                const featuresContainer = document.getElementById('tutorialFeatures');
                featuresContainer.innerHTML = step.features.map(feature => `
                    <div class="tutorial-feature">
                        <span class="tutorial-feature-icon">${feature.icon}</span>
                        <span class="tutorial-feature-text">${feature.text}</span>
                    </div>
                `).join('');
                
                // Update buttons
                const prevButton = document.getElementById('tutorialPrevButton');
                const nextButton = document.getElementById('tutorialNextButton');
                const skipButton = document.getElementById('tutorialSkipButton');
                
                prevButton.style.display = this.currentTutorialStep === 0 ? 'none' : 'inline-block';
                
                if (this.currentTutorialStep === this.tutorialSteps.length - 1) {
                    nextButton.textContent = 'Get Started!';
                    skipButton.style.display = 'none';
                } else {
                    nextButton.textContent = 'Next';
                    skipButton.style.display = 'inline-block';
                }
            }

            nextTutorialStep() {
                if (this.currentTutorialStep < this.tutorialSteps.length - 1) {
                    this.currentTutorialStep++;
                    this.renderTutorialStep();
                } else {
                    this.closeTutorial();
                }
            }

            previousTutorialStep() {
                if (this.currentTutorialStep > 0) {
                    this.currentTutorialStep--;
                    this.renderTutorialStep();
                }
            }

            closeTutorial() {
                document.getElementById('tutorialOverlay').style.display = 'none';
                localStorage.setItem('headsup_tutorial_seen', 'true');
            }

            // Settings Menu
            toggleSettings(e) {
                e.stopPropagation();
                const menu = document.getElementById('settingsMenu');
                menu.classList.toggle('visible');
            }

            hideSettings() {
                const menu = document.getElementById('settingsMenu');
                menu.classList.remove('visible');
            }

            clearAllMappings() {
                if (confirm('Are you sure you want to clear all content mappings? This cannot be undone.')) {
                    this.contentMappings = [];
                    this.saveContentMappings();
                    this.renderContentMappings();
                    this.hideSettings();
                }
            }

            exportMappings() {
                const dataStr = JSON.stringify(this.contentMappings, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'headsup-mappings.json';
                link.click();
                URL.revokeObjectURL(url);
                this.hideSettings();
            }

            // Session Management
            logSessionEvent(event) {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] Heads Up: ${event}`);
                
                // Store session logs
                if (!this.sessionLogs) {
                    this.sessionLogs = [];
                }
                this.sessionLogs.push({
                    event: event,
                    timestamp: new Date(),
                    sessionData: {
                        wordCount: this.wordCount,
                        sentenceCount: this.sentenceCount,
                        duration: this.sessionStartTime ? Math.floor((Date.now() - this.sessionStartTime) / 1000) : 0
                    }
                });
            }

            addSessionSummaryCard() {
                if (!this.recordingStartTimestamp || !this.recordingEndTimestamp) {
                    return;
                }

                const duration = Math.floor((this.recordingEndTimestamp - this.recordingStartTimestamp) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                const durationText = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                const startTime = this.recordingStartTimestamp.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
                const endTime = this.recordingEndTimestamp.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});

                const summaryContent = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                        <div>
                            <strong>📅 Session Time:</strong><br>
                            ${startTime} - ${endTime}
                        </div>
                        <div>
                            <strong>⏱️ Duration:</strong><br>
                            ${durationText}
                        </div>
                        <div>
                            <strong>💬 Words Captured:</strong><br>
                            ${this.wordCount} words
                        </div>
                        <div>
                            <strong>📝 Sentences:</strong><br>
                            ${this.sentenceCount} sentences
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; opacity: 0.8;">
                        Session completed at ${endTime}
                    </div>
                `;

                this.addCoaching('📊 Session Summary', summaryContent, 'opportunity', 'bar-chart-2');
            }

            // Session Management
            clearCoachingTips() {
                const coachingGrid = document.getElementById('coachingGrid');
                coachingGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🧠</div>
                        <div class="empty-title">Heads Up</div>
                        <div class="empty-subtitle">
                            Start recording to receive real-time coaching insights based on your speech patterns and content mappings.
                        </div>
                    </div>
                `;
            }

            showSaveSessionOption() {
                if (this.currentSessionTranscript.trim().length > 0) {
                    const saveSessionButton = document.getElementById('saveSessionButton');
                    saveSessionButton.style.display = 'flex';
                }
            }

            showSummarizeOption() {
                if (this.currentSessionTranscript.trim().length > 0 && this.llmConfig.apiKey) {
                    switch (this.llmConfig.autoSummarize) {
                        case 'always':
                            // Auto summarize immediately
                            this.summarizeWithLLM();
                            break;
                        case 'ask':
                            // Show manual summarize button
                            const summarizeButton = document.getElementById('summarizeButton');
                            summarizeButton.style.display = 'flex';
                            break;
                        case 'never':
                        default:
                            // Do nothing - no button, no auto-summarize
                            break;
                    }
                }
            }

            saveCurrentSession() {
                if (this.currentSessionTranscript.trim().length === 0) {
                    alert('No session data to save.');
                    return;
                }

                const sessionName = prompt('Enter a name for this session:', 
                    `Session ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}`);
                
                if (!sessionName) {
                    return; // User cancelled
                }

                const sessionData = {
                    id: Date.now(),
                    name: sessionName,
                    transcript: this.currentSessionTranscript,
                    startTime: this.recordingStartTimestamp,
                    endTime: this.recordingEndTimestamp,
                    wordCount: this.wordCount,
                    sentenceCount: this.sentenceCount,
                    duration: this.recordingEndTimestamp ? 
                        Math.floor((this.recordingEndTimestamp - this.recordingStartTimestamp) / 1000) : 0,
                    savedAt: new Date()
                };

                this.savedSessions.push(sessionData);
                this.saveSessions();
                
                // Clear current session and UI
                this.clearCurrentSession();
                
                if (window.electronAPI) {
                    window.electronAPI.showNotification({
                        title: 'Session Saved',
                        body: `Session "${sessionName}" saved successfully!`
                    });
                } else {
                    alert(`Session "${sessionName}" saved successfully!`);
                }
            }

            clearCurrentSession() {
                // Clear live view
                const wordStream = document.getElementById('wordStream');
                wordStream.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🎙️</div>
                        <div class="empty-title">Ready for Live Transcription</div>
                        <div class="empty-subtitle">Speak naturally and watch your words flow in real-time</div>
                    </div>
                `;
                
                // Clear coaching grid
                const coachingGrid = document.getElementById('coachingGrid');
                coachingGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🧠</div>
                        <div class="empty-title">Heads Up</div>
                        <div class="empty-subtitle">
                            Start recording to receive real-time coaching insights based on your speech patterns and content mappings.
                        </div>
                    </div>
                `;
                
                // Reset session data
                this.resetSession();
                
                // Hide save and summarize buttons
                const saveSessionButton = document.getElementById('saveSessionButton');
                const summarizeButton = document.getElementById('summarizeButton');
                saveSessionButton.style.display = 'none';
                summarizeButton.style.display = 'none';
            }

            viewSavedSessions() {
                if (this.savedSessions.length === 0) {
                    alert('No saved sessions found.');
                    return;
                }

                const sessionsList = this.savedSessions.map((session, index) => {
                    const duration = Math.floor(session.duration / 60) + ':' + (session.duration % 60).toString().padStart(2, '0');
                    return `${index + 1}. ${session.name} (${session.wordCount} words, ${duration}) - ${session.savedAt.toLocaleDateString()}`;
                }).join('\n');

                const choice = prompt(`Saved Sessions:\n\n${sessionsList}\n\nEnter session number to view, or 'export' to download all sessions:`);
                
                if (choice === 'export') {
                    this.exportSessions();
                } else {
                    const sessionIndex = parseInt(choice) - 1;
                    if (sessionIndex >= 0 && sessionIndex < this.savedSessions.length) {
                        this.viewSessionDetails(this.savedSessions[sessionIndex]);
                    }
                }
                
                this.hideSettings();
            }

            viewSessionDetails(session) {
                const duration = Math.floor(session.duration / 60) + ':' + (session.duration % 60).toString().padStart(2, '0');
                const details = `Session: ${session.name}\n` +
                    `Date: ${session.startTime.toLocaleDateString()} ${session.startTime.toLocaleTimeString()}\n` +
                    `Duration: ${duration}\n` +
                    `Words: ${session.wordCount} | Sentences: ${session.sentenceCount}\n\n` +
                    `Transcript:\n${session.transcript}`;
                
                const action = prompt(details + '\n\nType "copy" to copy transcript to clipboard, or press OK to close:');
                
                if (action === 'copy') {
                    navigator.clipboard.writeText(session.transcript).then(() => {
                        alert('Transcript copied to clipboard!');
                    }).catch(() => {
                        alert('Could not copy to clipboard.');
                    });
                }
            }

            exportSessions() {
                const dataStr = JSON.stringify(this.savedSessions, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `headsup-sessions-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            }

            saveSessions() {
                localStorage.setItem('headsup_saved_sessions', JSON.stringify(this.savedSessions));
            }

            loadSavedSessions() {
                const stored = localStorage.getItem('headsup_saved_sessions');
                if (stored) {
                    this.savedSessions = JSON.parse(stored).map(session => ({
                        ...session,
                        startTime: new Date(session.startTime),
                        endTime: new Date(session.endTime),
                        savedAt: new Date(session.savedAt)
                    }));
                }
            }

            // LLM Integration
            showLLMSettings() {
                const settingsHTML = `
                    <div style="background: rgba(0,0,0,0.87); position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
                        <div style="background: linear-gradient(135deg, rgba(26, 26, 26, 0.96) 0%, rgba(42, 42, 42, 0.96) 100%); border: 1px solid rgba(255,255,255,0.15); border-radius: 20px; padding: 2rem; max-width: 600px; width: 90%; color: white;">
                            <h3 style="margin: 0 0 1.5rem 0; color: #00d4ff;">🤖 LLM Configuration</h3>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Provider:</label>
                                <select id="llmProvider" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                                    <option value="openai">OpenAI</option>
                                    <option value="claude">Claude (Anthropic)</option>
                                    <option value="ollama">Ollama (Local)</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">API Key:</label>
                                <input type="password" id="llmApiKey" placeholder="Enter your API key" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                            </div>
                            
                            <div style="margin-bottom: 1rem;" id="llmBaseUrlDiv">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Base URL (Ollama):</label>
                                <input type="text" id="llmBaseUrl" placeholder="http://localhost:11434" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Model:</label>
                                <input type="text" id="llmModel" placeholder="gpt-3.5-turbo" style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Analysis Prompt:</label>
                                <textarea id="llmPrompt" rows="4" placeholder="Enter your custom prompt..." style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; resize: vertical; font-family: inherit;"></textarea>
                                <small style="color: #888; font-size: 0.8rem;">Use {transcript} as placeholder for the conversation text</small>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Auto-Summarize:</label>
                                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="radio" name="autoSummarize" value="never" style="margin: 0;">
                                        <span>Never</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="radio" name="autoSummarize" value="ask" style="margin: 0;">
                                        <span>Ask each time</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="radio" name="autoSummarize" value="always" style="margin: 0;">
                                        <span>Always auto-summarize</span>
                                    </label>
                                </div>
                                <small style="color: #888; font-size: 0.8rem;">Choose when to analyze sessions with LLM</small>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 0.75rem 1.5rem; background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 8px; cursor: pointer;">Cancel</button>
                                <button onclick="app.saveLLMConfig(); this.parentElement.parentElement.parentElement.remove();" style="padding: 0.75rem 1.5rem; background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Save</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', settingsHTML);
                
                // Populate current values
                document.getElementById('llmProvider').value = this.llmConfig.provider;
                document.getElementById('llmApiKey').value = this.llmConfig.apiKey;
                document.getElementById('llmBaseUrl').value = this.llmConfig.baseUrl;
                document.getElementById('llmModel').value = this.llmConfig.model;
                document.getElementById('llmPrompt').value = this.llmConfig.prompt;
                
                // Set auto-summarize radio button
                const autoSummarizeValue = this.llmConfig.autoSummarize || 'ask';
                document.querySelector(`input[name="autoSummarize"][value="${autoSummarizeValue}"]`).checked = true;
                
                // Handle provider change
                document.getElementById('llmProvider').addEventListener('change', (e) => {
                    const baseUrlDiv = document.getElementById('llmBaseUrlDiv');
                    baseUrlDiv.style.display = e.target.value === 'ollama' ? 'block' : 'none';
                    
                    // Update default model based on provider
                    const modelInput = document.getElementById('llmModel');
                    switch(e.target.value) {
                        case 'openai':
                            modelInput.placeholder = 'gpt-3.5-turbo';
                            break;
                        case 'claude':
                            modelInput.placeholder = 'claude-3-sonnet-20240229';
                            break;
                        case 'ollama':
                            modelInput.placeholder = 'llama2';
                            break;
                    }
                });
                
                // Trigger initial provider change
                document.getElementById('llmProvider').dispatchEvent(new Event('change'));
                
                this.hideSettings();
            }

            saveLLMConfig() {
                this.llmConfig.provider = document.getElementById('llmProvider').value;
                this.llmConfig.apiKey = document.getElementById('llmApiKey').value;
                this.llmConfig.baseUrl = document.getElementById('llmBaseUrl').value;
                this.llmConfig.model = document.getElementById('llmModel').value;
                this.llmConfig.prompt = document.getElementById('llmPrompt').value;
                this.llmConfig.autoSummarize = document.querySelector('input[name="autoSummarize"]:checked').value;
                
                localStorage.setItem('headsup_llm_config', JSON.stringify(this.llmConfig));
                
                if (window.electronAPI) {
                    window.electronAPI.showNotification({
                        title: 'Settings Saved',
                        body: 'LLM configuration saved successfully!'
                    });
                } else {
                    alert('LLM configuration saved!');
                }
            }

            loadLLMConfig() {
                const stored = localStorage.getItem('headsup_llm_config');
                if (stored) {
                    this.llmConfig = { ...this.llmConfig, ...JSON.parse(stored) };
                }
            }

            async summarizeWithLLM() {
                if (!this.llmConfig.apiKey) {
                    alert('Please configure LLM settings first.');
                    return;
                }
                
                if (!this.currentSessionTranscript.trim()) {
                    alert('No transcript to analyze.');
                    return;
                }
                
                const summarizeButton = document.getElementById('summarizeButton');
                const originalText = summarizeButton.querySelector('i').className;
                const originalIcon = summarizeButton.querySelector('i').getAttribute('data-feather');
                summarizeButton.querySelector('i').setAttribute('data-feather', 'loader');
                feather.replace();
                summarizeButton.disabled = true;
                
                try {
                    let response;
                    const prompt = this.llmConfig.prompt.replace('{transcript}', this.currentSessionTranscript);
                    
                    switch(this.llmConfig.provider) {
                        case 'openai':
                            response = await this.callOpenAI(prompt);
                            break;
                        case 'claude':
                            response = await this.callClaude(prompt);
                            break;
                        case 'ollama':
                            response = await this.callOllama(prompt);
                            break;
                        default:
                            throw new Error('Unknown provider');
                    }
                    
                    this.addCoaching('🤖 LLM Analysis', response, 'opportunity', 'cpu');
                    
                } catch (error) {
                    console.error('LLM Analysis Error:', error);
                    alert('Failed to analyze transcript: ' + error.message);
                } finally {
                    summarizeButton.querySelector('i').setAttribute('data-feather', originalIcon || 'zap');
                    feather.replace();
                    summarizeButton.disabled = false;
                }
            }

            async callOpenAI(prompt) {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.llmConfig.apiKey}`
                    },
                    body: JSON.stringify({
                        model: this.llmConfig.model,
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 1000
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`OpenAI API error: ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            }

            async callClaude(prompt) {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': this.llmConfig.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: this.llmConfig.model,
                        max_tokens: 1000,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Claude API error: ${response.status}`);
                }
                
                const data = await response.json();
                return data.content[0].text;
            }

            async callOllama(prompt) {
                const response = await fetch(`${this.llmConfig.baseUrl}/api/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: this.llmConfig.model,
                        prompt: prompt,
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Ollama API error: ${response.status}`);
                }
                
                const data = await response.json();
                return data.response;
            }

            // Electron Integration
            setupElectronIntegration() {
                if (window.electronAPI) {
                    // Setup menu action listeners
                    window.electronAPI.onMenuAction((event, action) => {
                        switch (event) {
                            case 'start-recording':
                                this.start();
                                break;
                            case 'stop-recording':
                                this.stop();
                                break;
                            case 'save-session':
                                this.saveCurrentSession();
                                break;
                            case 'clear-session':
                                this.clearCurrentSession();
                                break;
                            case 'toggle-content-mapping':
                                this.toggleContentMapping();
                                break;
                            case 'show-tutorial':
                                this.showTutorial();
                                break;
                            case 'show-preferences':
                                this.showLLMSettings();
                                break;
                        }
                    });

                    // Setup auto-updater listeners
                    window.electronAPI.onUpdateAvailable((event, info) => {
                        this.addCoaching('🔄 Update Available', `Version ${info.version} is available. It will be downloaded in the background.`, 'opportunity', 'download');
                    });

                    window.electronAPI.onUpdateDownloaded((event, info) => {
                        this.addCoaching('✅ Update Ready', 'Update downloaded. Restart the app to apply the new version.', 'opportunity', 'refresh-cw');
                    });

                    // Enhanced notifications
                    this.showNotification = (title, body, options = {}) => {
                        window.electronAPI.showNotification({ title, body, ...options });
                    };

                    // Enhanced storage
                    this.electronStore = {
                        get: (key) => window.electronAPI.store.get(key),
                        set: (key, value) => window.electronAPI.store.set(key, value),
                        delete: (key) => window.electronAPI.store.delete(key)
                    };
                }
            }

            async saveSessionToFile() {
                if (!window.electronAPI || !this.currentSessionTranscript.trim()) {
                    return this.saveCurrentSession(); // Fallback to localStorage
                }

                try {
                    const result = await window.electronAPI.showSaveDialog({
                        title: 'Save Session Transcript',
                        defaultPath: `session-${new Date().toISOString().split('T')[0]}.json`,
                        filters: [
                            { name: 'JSON Files', extensions: ['json'] },
                            { name: 'Text Files', extensions: ['txt'] },
                            { name: 'All Files', extensions: ['*'] }
                        ]
                    });

                    if (!result.canceled) {
                        const sessionData = {
                            name: `Session ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`,
                            transcript: this.currentSessionTranscript,
                            startTime: this.recordingStartTimestamp,
                            endTime: this.recordingEndTimestamp,
                            wordCount: this.wordCount,
                            sentenceCount: this.sentenceCount,
                            duration: this.recordingEndTimestamp ? 
                                Math.floor((this.recordingEndTimestamp - this.recordingStartTimestamp) / 1000) : 0,
                            savedAt: new Date(),
                            contentMappings: this.contentMappings
                        };

                        // Note: In a real implementation, you'd use fs through the main process
                        // For now, we'll still use the localStorage method but show the dialog
                        this.saveCurrentSession();
                        
                        if (window.electronAPI.showNotification) {
                            window.electronAPI.showNotification({
                                title: 'Session Saved',
                                body: `Session saved successfully!`
                            });
                        }
                    }
                } catch (error) {
                    console.error('Failed to save session:', error);
                    this.saveCurrentSession(); // Fallback
                }
            }

            // Card Dismissal
            dismissCard(button) {
                const card = button.closest('.coaching-card');
                if (card) {
                    // Add dismissing animation class
                    card.classList.add('dismissing');
                    
                    // Remove the card after animation completes
                    setTimeout(() => {
                        if (card.parentNode) {
                            card.parentNode.removeChild(card);
                            
                            // Check if coaching grid is empty and show empty state
                            const coachingGrid = document.getElementById('coachingGrid');
                            if (coachingGrid.children.length === 0) {
                                coachingGrid.innerHTML = `
                                    <div class="empty-state">
                                        <div class="empty-icon">🧠</div>
                                        <div class="empty-title">Heads Up</div>
                                        <div class="empty-subtitle">
                                            Start recording to receive real-time coaching insights based on your speech patterns and content mappings.
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    }, 300); // Match the CSS transition duration
                }
            }
        }

        // Initialize
        const app = new HeadsUp();
    </script>

    <!-- Tutorial Overlay -->
    <div class="tutorial-overlay" id="tutorialOverlay" style="display: none;">
        <div class="tutorial-card">
            <div class="tutorial-step-indicator" id="tutorialStepIndicator"></div>
            <div class="tutorial-icon" id="tutorialIcon">🎙️</div>
            <div class="tutorial-title" id="tutorialTitle">Welcome to Heads Up</div>
            <div class="tutorial-description" id="tutorialDescription">Your AI-powered sales coaching assistant</div>
            <div class="tutorial-features" id="tutorialFeatures"></div>
            <div class="tutorial-buttons">
                <button class="tutorial-button tutorial-button-secondary" id="tutorialPrevButton" onclick="app.previousTutorialStep()">Previous</button>
                <button class="tutorial-button tutorial-button-secondary" id="tutorialSkipButton" onclick="app.closeTutorial()">Skip Tutorial</button>
                <button class="tutorial-button tutorial-button-primary" id="tutorialNextButton" onclick="app.nextTutorialStep()">Next</button>
            </div>
        </div>
    </div>
</body>
</html>